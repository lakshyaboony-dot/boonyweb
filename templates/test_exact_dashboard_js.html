{% extends "base.html" %}
{% block title %}Exact Dashboard JS Test{% endblock %}

{% block content %}
<div class="modern-dashboard">
    <h1>Testing Exact Dashboard JavaScript Structure</h1>
    <div id="output"></div>
    
    <!-- Mock elements that dashboard expects -->
    <div id="daySelector"></div>
    <div id="starNotification" style="display: none;"></div>
    <div id="congratulationsModal" style="display: none;"></div>
    <button id="uploadBtn">Upload</button>
    <input type="file" id="photoInput" style="display: none;">
    <div id="uploadStatus"></div>
    <img id="profileImg" src="#" alt="Profile">
</div>

<script>
// Copy the exact JavaScript structure from dashboard.html
document.addEventListener('DOMContentLoaded', function() {
    console.log('Testing exact dashboard JavaScript structure...');
    
    // Template variables exactly as in dashboard
    const isPracticeMode = {{ ('true' if is_practice_mode else 'false')|tojson|safe }};
    const currentDay = {{ day|tojson|safe }};
    const currentUserId = {{ current_user.user_id|tojson|safe }};
    const starOfDayUserId = {{ star_of_day_user_id|tojson|safe }};
    const starOfWeekUserId = {{ star_of_week_user_id|tojson|safe }};
    const credits = {
        listen: {{ credits.listen|tojson|safe }},
        speak: {{ credits.speak|tojson|safe }},
        vocabulary: {{ credits.vocabulary|tojson|safe }},
        revision: {{ credits.revision|tojson|safe }}
    };
    
    // DOM elements exactly as in dashboard
    const daySelector = document.getElementById('daySelector');
    const uploadBtn = document.getElementById('uploadBtn');
    const photoInput = document.getElementById('photoInput');
    const uploadStatus = document.getElementById('uploadStatus');
    const profileImg = document.getElementById('profileImg');
    
    // Functions exactly as in dashboard
    function getUserLanguage() {
        return localStorage.getItem('boony.language') || 'hinglish';
    }
    
    const dashboardTexts = {
        hinglish: {
            selectPhoto: 'कृपया पहले एक फोटो चुनें',
            fileTypeError: 'केवल PNG, JPG, JPEG फाइलें allowed हैं',
            uploading: 'अपलोड हो रहा है...',
            uploadSuccess: '✅ फोटो सफलतापूर्वक अपलोड हो गई!',
            uploadError: 'अपलोड में त्रुटि हुई',
            upload: 'Upload Photo'
        },
        english: {
            selectPhoto: 'Please select a photo first',
            fileTypeError: 'Only PNG, JPG, JPEG files are allowed',
            uploading: 'Uploading...',
            uploadSuccess: '✅ Photo uploaded successfully!',
            uploadError: 'Upload failed',
            upload: 'Upload Photo'
        }
    };
    
    // Photo upload functionality exactly as in dashboard
    if (uploadBtn && photoInput && uploadStatus && profileImg) {
        uploadBtn.addEventListener('click', function() {
            photoInput.click();
        });
        
        photoInput.addEventListener('change', function() {
            const file = this.files[0];
            const currentLang = getUserLanguage();
            const texts = dashboardTexts[currentLang] || dashboardTexts.hinglish;
            
            if (!file) {
                uploadStatus.innerHTML = `<span class="error-text">${texts.selectPhoto}</span>`;
                return;
            }
            
            const allowedTypes = ['image/png', 'image/jpg', 'image/jpeg'];
            if (!allowedTypes.includes(file.type)) {
                uploadStatus.innerHTML = `<span class="error-text">${texts.fileTypeError}</span>`;
                return;
            }
        });
    }
    
    // Day selector population exactly as in dashboard
    function populateDaySelector() {
        if (!daySelector) return;
        
        fetch('/api/get_completed_days')
        .then(response => response.json())
        .then(data => {
            daySelector.innerHTML = '';
            
            if (data.completed_days && data.completed_days.length > 0) {
                data.completed_days.forEach(day => {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day.replace('-', ' ');
                    if (day === currentDay) {
                        option.selected = true;
                    }
                    daySelector.appendChild(option);
                });
            } else {
                const currentDayNum = parseInt(currentDay.split('-')[1]);
                for (let i = 1; i <= currentDayNum; i++) {
                    const option = document.createElement('option');
                    option.value = `Day-${i}`;
                    option.textContent = `Day ${i}`;
                    if (`Day-${i}` === currentDay) {
                        option.selected = true;
                    }
                    daySelector.appendChild(option);
                }
            }
        })
        .catch(error => {
            console.error('Error fetching completed days:', error);
            const currentDayNum = parseInt(currentDay.split('-')[1]);
            for (let i = 1; i <= currentDayNum; i++) {
                const option = document.createElement('option');
                option.value = `Day-${i}`;
                option.textContent = `Day ${i}`;
                if (`Day-${i}` === currentDay) {
                    option.selected = true;
                }
                daySelector.appendChild(option);
            }
        });
        
        daySelector.addEventListener('change', function() {
            const selectedDay = this.value;
            if (selectedDay && selectedDay !== currentDay) {
                window.location.href = `/dashboard?practice_day=${selectedDay}`;
            }
        });
    }
    
    // Initialize functions
    populateDaySelector();
    
    console.log('Exact dashboard JavaScript structure test completed!');
    document.getElementById('output').innerHTML = '<p style="color: green;">✅ Exact dashboard JS structure test passed!</p>';
});
</script>
{% endblock %}